import cv2
import numpy as np
import dlib
from imutils import face_utils
import time
import winsound  
import platform
import os


cap = cv2.VideoCapture(0)
detector = dlib.get_frontal_face_detector()
predictor = dlib.shape_predictor("shape_predictor_68_face_landmarks.dat")


sleep = drowsy = active = yawn = 0
status = "Initializing..."
eye_status = "Detecting..."
mouth_status = "Detecting..."
head_status = "Centered"
color = (0, 0, 0)


alarm_active = False
alarm_start_time = 0
ALARM_DURATION = 5  
last_beep_time = 0
BEEP_INTERVAL = 0.5 


perclos_window = 60  
perclos_buffer = []
perclos = 0


EAR_THRESHOLD_CLOSED = 0.21
EAR_THRESHOLD_PARTIAL = 0.25
MAR_THRESHOLD_YAWN = 0.75
HEAD_TILT_THRESHOLD = 15  
LOOK_DOWN_THRESHOLD = 0.7  

def compute(ptA, ptB):
    return np.linalg.norm(ptA - ptB)

def eye_aspect_ratio(eye_points):
    """Calculate Eye Aspect Ratio"""
    A = compute(eye_points[1], eye_points[5])
    B = compute(eye_points[2], eye_points[4])
    C = compute(eye_points[0], eye_points[3])
    ear = (A + B) / (2.0 * C)
    return ear

def mouth_aspect_ratio(mouth_points):
    """Calculate Mouth Aspect Ratio"""
    A = compute(mouth_points[1], mouth_points[11])  
    B = compute(mouth_points[2], mouth_points[10])   
    C = compute(mouth_points[3], mouth_points[9]) 
    D = compute(mouth_points[4], mouth_points[8])
    E = compute(mouth_points[5], mouth_points[7])
    F = compute(mouth_points[0], mouth_points[6])
    mar = (A + B + C + D + E) / (5.0 * F)
    return mar

def calculate_perclos(ear_value, threshold=EAR_THRESHOLD_CLOSED):
    """Calculate PERCLOS (Percentage of Eye Closure)"""
    global perclos_buffer, perclos_window
    
   
    is_closed = 1 if ear_value <= threshold else 0
    perclos_buffer.append(is_closed)
    
    
    if len(perclos_buffer) > perclos_window:
        perclos_buffer.pop(0)
    
   
    if len(perclos_buffer) > 0:
        perclos = sum(perclos_buffer) / len(perclos_buffer)
    else:
        perclos = 0
        
    return perclos

def simple_head_tilt(landmarks):
    """Improved head tilt detection using facial landmarks"""
    
    nose_tip = landmarks[30]
    left_eye = landmarks[36]
    right_eye = landmarks[45]
    chin = landmarks[8]
    forehead = landmarks[27] 
    
   
    eye_center_x = (left_eye[0] + right_eye[0]) / 2
    roll_angle = np.degrees(np.arctan2(right_eye[1] - left_eye[1], right_eye[0] - left_eye[0]))
    
   
    face_height = chin[1] - forehead[1]
    nose_to_chin = chin[1] - nose_tip[1]
    
   
    pitch_ratio = nose_to_chin / face_height if face_height > 0 else 0
    
    tilt_status = "Centered"
    tilt_color = (0, 255, 0)  
    
    
    if abs(roll_angle) > HEAD_TILT_THRESHOLD:
        if roll_angle > 0:
            tilt_status = "Tilted Right"
            tilt_color = (0, 165, 255)  
        else:
            tilt_status = "Tilted Left"
            tilt_color = (0, 165, 255) 
    
    elif pitch_ratio > LOOK_DOWN_THRESHOLD:
        tilt_status = "Looking Down"
        tilt_color = (0, 0, 255) 
    
  
    elif nose_tip[1] < forehead[1]: 
        tilt_status = "Looking Up"
        tilt_color = (0, 255, 255) 
    
    return tilt_status, tilt_color, roll_angle

def play_alarm_sound():
    """Play an alarm sound that works on Windows, macOS, and Linux"""
    system = platform.system()
    
    try:
        if system == "Windows":
            winsound.Beep(1000, 500)  
        elif system == "Darwin":  
            os.system('afplay /System/Library/Sounds/Ping.aiff &')
        elif system == "Linux":
            os.system('beep -f 1000 -l 500')
    except:
        print("Could not play alarm sound")

def trigger_alarm():
    """Activate the alarm system"""
    global alarm_active, alarm_start_time
    alarm_active = True
    alarm_start_time = time.time()
    play_alarm_sound()

def check_alarm():
    """Check if alarm should be active and manage its state"""
    global alarm_active, alarm_start_time, last_beep_time
    
    if alarm_active:
       
        if time.time() - alarm_start_time > ALARM_DURATION:
            alarm_active = False
        else:
           
            current_time = time.time()
            if current_time - last_beep_time > BEEP_INTERVAL:
                play_alarm_sound()
                last_beep_time = current_time


LEFT_EYE_POINTS = list(range(36, 42))
RIGHT_EYE_POINTS = list(range(42, 48))
MOUTH_POINTS = list(range(48, 68))

while True:
    ret, frame = cap.read()
    if not ret:
        break
    
    frame = cv2.flip(frame, 1)
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    faces = detector(gray, 0)
    
    
    check_alarm()
    
    
    if alarm_active:
        
        if int(time.time() * 2) % 2 == 0:
            overlay = frame.copy()
            cv2.rectangle(overlay, (0, 0), (frame.shape[1], frame.shape[0]), (0, 0, 255), -1)
            frame = cv2.addWeighted(overlay, 0.3, frame, 0.7, 0)
            
           
            cv2.putText(frame, "WAKE UP! ALARM ACTIVE!", (frame.shape[1]//2 - 180, 50), 
                       cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 3)
    
    for face in faces:
        
        x1, y1, x2, y2 = face.left(), face.top(), face.right(), face.bottom()
        cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
        
       
        landmarks = predictor(gray, face)
        landmarks = face_utils.shape_to_np(landmarks)
        
        
        left_eye = [landmarks[i] for i in LEFT_EYE_POINTS]
        right_eye = [landmarks[i] for i in RIGHT_EYE_POINTS]
        mouth = [landmarks[i] for i in MOUTH_POINTS]
        
        
        left_ear = eye_aspect_ratio(left_eye)
        right_ear = eye_aspect_ratio(right_eye)
        ear = (left_ear + right_ear) / 2.0
        mar = mouth_aspect_ratio(mouth)
        
        
        perclos = calculate_perclos(ear)
        
       
        head_status, head_color, tilt_angle = simple_head_tilt(landmarks)
        
        
        if ear <= EAR_THRESHOLD_CLOSED:
            sleep += 1
            drowsy = active = 0
            eye_status = "CLOSED"
        elif ear <= EAR_THRESHOLD_PARTIAL:
            sleep = 0
            drowsy += 1
            active = 0
            eye_status = "DROWSY"
        else:
            sleep = drowsy = 0
            active += 1
            eye_status = "OPEN"
        
        
        if mar > MAR_THRESHOLD_YAWN:
            mouth_status = "YAWNING"
            yawn += 1
        else:
            mouth_status = "NORMAL"
            yawn = max(0, yawn - 0.5)
        
        
        if sleep > 10:
            status = "SLEEPING!"
            color = (0, 0, 255)
            
            if not alarm_active:
                trigger_alarm()
        elif drowsy > 8 or yawn > 6 or perclos > 0.3:
            status = "DROWSY!"
            color = (0, 165, 255)
            if not alarm_active:
                trigger_alarm()
        elif "Looking Down" in head_status and (drowsy > 3 or ear < EAR_THRESHOLD_PARTIAL):
            status = "DROWSY (Head Down)"
            color = (0, 165, 255)
        elif yawn > 4:
            status = "YAWNING"
            color = (0, 255, 255)
        else:
            status = "ACTIVE"
            color = (0, 255, 0)
        
        
        info_text = [
            f"Status: {status}",
            f"EAR: {ear:.3f} (Eyes: {eye_status})",
            f"MAR: {mar:.3f} (Mouth: {mouth_status})",
            f"Head: {head_status} ({tilt_angle:.1f}Â°)",
            f"PERCLOS: {perclos:.2f}",
            f"Counters - Sleep: {sleep}, Drowsy: {drowsy}, Yawn: {yawn:.1f}",
            f"Alarm: {'ACTIVE' if alarm_active else 'INACTIVE'}"
        ]
        
        for i, text in enumerate(info_text):
            cv2.putText(frame, text, (10, 30 + i*25), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.6, color if i == 0 else (255, 255, 255), 2)
        
       
        nose_tip = landmarks[30]
        left_eye_center = np.mean([landmarks[i] for i in LEFT_EYE_POINTS], axis=0)
        right_eye_center = np.mean([landmarks[i] for i in RIGHT_EYE_POINTS], axis=0)
        
        
        cv2.line(frame, 
                (int(left_eye_center[0]), int(left_eye_center[1])),
                (int(right_eye_center[0]), int(right_eye_center[1])),
                head_color, 2)
        
        
        for (x, y) in left_eye + right_eye:
            cv2.circle(frame, (x, y), 2, (255, 0, 0), -1)
        
        for (x, y) in mouth:
            cv2.circle(frame, (x, y), 2, (0, 255, 255), -1)
        
       
        cv2.circle(frame, (int(nose_tip[0]), int(nose_tip[1])), 5, (0, 0, 255), -1)
    
   
    cv2.imshow("Drowsiness & Head Pose Detection", frame)
    
   
    if cv2.waitKey(1) & 0xFF == 27:
        break

cap.release()
cv2.destroyAllWindows()